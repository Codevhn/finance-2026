/**
 * Goal Entity - Meta Mensual
 * Representa una meta financiera mensual con aportes y auto-reinicio
 */

export class Goal {
  constructor(data = {}) {
    this.id = data.id || null;
    this.nombre = data.nombre || "";
    this.montoObjetivo = data.montoObjetivo || 0;
    this.aportes = data.aportes || []; // Array de { monto, fecha }
    this.fechaCreacion = data.fechaCreacion || new Date().toISOString();
    this.completada = data.completada || false;
    this.cicloActual = data.cicloActual || 1;
    this.fechaCompletado = data.fechaCompletado || null;

    // Campos para sincronización futura
    this.syncStatus = data.syncStatus || "local"; // 'local', 'synced', 'pending'
    this.lastSyncedAt = data.lastSyncedAt || null;
    this.remoteId = data.remoteId || null;
  }

  /**
   * Agregar un aporte a la meta
   * @param {number} monto - Monto del aporte en Lempiras
   * @returns {Object} - Resultado de la operación
   */
  agregarAporte(monto) {
    if (monto <= 0) {
      return { success: false, error: "El monto debe ser mayor a 0" };
    }

    const aporte = {
      monto: parseFloat(monto),
      fecha: new Date().toISOString(),
    };

    this.aportes.push(aporte);
    this.syncStatus = "pending";

    // Verificar si se completó la meta
    const progresoActual = this.calcularProgreso();
    if (progresoActual >= 100 && !this.completada) {
      this.marcarCompletada();
    }

    return { success: true, aporte, progreso: progresoActual };
  }

  /**
   * Calcular el progreso actual de la meta
   * @returns {number} - Porcentaje de progreso (0-100+)
   */
  calcularProgreso() {
    const totalAportado = this.aportes.reduce(
      (sum, aporte) => sum + aporte.monto,
      0
    );
    if (this.montoObjetivo === 0) return 0;
    return (totalAportado / this.montoObjetivo) * 100;
  }

  /**
   * Obtener el total aportado
   * @returns {number} - Total en Lempiras
   */
  getTotalAportado() {
    return this.aportes.reduce((sum, aporte) => sum + aporte.monto, 0);
  }

  /**
   * Obtener el monto restante para completar
   * @returns {number} - Monto restante en Lempiras
   */
  getMontoRestante() {
    const restante = this.montoObjetivo - this.getTotalAportado();
    return Math.max(0, restante);
  }

  /**
   * Marcar la meta como completada
   */
  marcarCompletada() {
    this.completada = true;
    this.fechaCompletado = new Date().toISOString();
    this.syncStatus = "pending";
  }

  /**
   * Reiniciar el ciclo de la meta (automático al completar)
   * @returns {Goal} - Nueva instancia de meta para el siguiente ciclo
   */
  reiniciarCiclo() {
    const nuevaMeta = new Goal({
      nombre: this.nombre,
      montoObjetivo: this.montoObjetivo,
      cicloActual: this.cicloActual + 1,
      fechaCreacion: new Date().toISOString(),
    });

    return nuevaMeta;
  }

  /**
   * Validar la meta
   * @returns {Object} - Resultado de validación
   */
  validar() {
    const errores = [];

    if (!this.nombre || this.nombre.trim() === "") {
      errores.push("El nombre es obligatorio");
    }

    if (this.montoObjetivo <= 0) {
      errores.push("El monto objetivo debe ser mayor a 0");
    }

    return {
      valido: errores.length === 0,
      errores,
    };
  }

  /**
   * Convertir a objeto plano para almacenamiento
   * @returns {Object}
   */
  toJSON() {
    return {
      id: this.id,
      nombre: this.nombre,
      montoObjetivo: this.montoObjetivo,
      aportes: this.aportes,
      fechaCreacion: this.fechaCreacion,
      completada: this.completada,
      cicloActual: this.cicloActual,
      fechaCompletado: this.fechaCompletado,
      syncStatus: this.syncStatus,
      lastSyncedAt: this.lastSyncedAt,
      remoteId: this.remoteId,
    };
  }
}
