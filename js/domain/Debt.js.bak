/**
 * Debt Entity - Deuda
 * Representa una deuda con pagos parciales y sistema de archivo
 */

export class Debt {
  constructor(data = {}) {
    this.id = data.id || null;
    this.nombre = data.nombre || "";
    this.totalAdeudado = data.totalAdeudado || 0;
    this.pagos = data.pagos || []; // Array de { monto, fecha, nota }
    this.fechaCreacion = data.fechaCreacion || new Date().toISOString();
    this.archivada = data.archivada || false;
    this.fechaArchivado = data.fechaArchivado || null;

    // Campos para sincronización futura
    this.syncStatus = data.syncStatus || "local";
    this.lastSyncedAt = data.lastSyncedAt || null;
    this.remoteId = data.remoteId || null;
  }

  /**
   * Agregar un pago a la deuda
   * @param {number} monto - Monto del pago en Lempiras
   * @param {string} nota - Nota opcional del pago
   * @returns {Object} - Resultado de la operación
   */
  agregarPago(monto, nota = "") {
    if (monto <= 0) {
      return { success: false, error: "El monto debe ser mayor a 0" };
    }

    const saldoActual = this.calcularSaldo();
    if (monto > saldoActual) {
      return {
        success: false,
        error: `El pago (Lps ${monto.toFixed(
          2
        )}) excede el saldo restante (Lps ${saldoActual.toFixed(2)})`,
      };
    }

    const pago = {
      monto: parseFloat(monto),
      fecha: new Date().toISOString(),
      nota: nota.trim(),
    };

    this.pagos.push(pago);
    this.syncStatus = "pending";

    const nuevoSaldo = this.calcularSaldo();

    // Auto-archivar si se completó el pago
    if (nuevoSaldo === 0) {
      this.archivar();
    }

    return {
      success: true,
      pago,
      saldoRestante: nuevoSaldo,
      completada: nuevoSaldo === 0,
    };
  }

  /**
   * Calcular el saldo restante de la deuda
   * @returns {number} - Saldo en Lempiras
   */
  calcularSaldo() {
    const totalPagado = this.pagos.reduce((sum, pago) => sum + pago.monto, 0);
    const saldo = this.totalAdeudado - totalPagado;
    return Math.max(0, saldo);
  }

  /**
   * Obtener el total pagado
   * @returns {number} - Total pagado en Lempiras
   */
  getTotalPagado() {
    return this.pagos.reduce((sum, pago) => sum + pago.monto, 0);
  }

  /**
   * Calcular el porcentaje de progreso del pago
   * @returns {number} - Porcentaje (0-100)
   */
  calcularProgreso() {
    if (this.totalAdeudado === 0) return 0;
    return (this.getTotalPagado() / this.totalAdeudado) * 100;
  }

  /**
   * Archivar la deuda (cuando se completa el pago)
   */
  archivar() {
    this.archivada = true;
    this.fechaArchivado = new Date().toISOString();
    this.syncStatus = "pending";
  }

  /**
   * Desarchivar la deuda
   */
  desarchivar() {
    this.archivada = false;
    this.fechaArchivado = null;
    this.syncStatus = "pending";
  }

  /**
   * Verificar si la deuda está completamente pagada
   * @returns {boolean}
   */
  estaCompletada() {
    return this.calcularSaldo() === 0;
  }

  /**
   * Validar la deuda
   * @returns {Object} - Resultado de validación
   */
  validar() {
    const errores = [];

    if (!this.nombre || this.nombre.trim() === "") {
      errores.push("El nombre es obligatorio");
    }

    if (this.totalAdeudado <= 0) {
      errores.push("El total adeudado debe ser mayor a 0");
    }

    return {
      valido: errores.length === 0,
      errores,
    };
  }

  /**
   * Convertir a objeto plano para almacenamiento
   * @returns {Object}
   */
  toJSON() {
    return {
      id: this.id,
      nombre: this.nombre,
      totalAdeudado: this.totalAdeudado,
      pagos: this.pagos,
      fechaCreacion: this.fechaCreacion,
      archivada: this.archivada,
      fechaArchivado: this.fechaArchivado,
      syncStatus: this.syncStatus,
      lastSyncedAt: this.lastSyncedAt,
      remoteId: this.remoteId,
    };
  }
}
